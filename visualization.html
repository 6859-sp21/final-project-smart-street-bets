<html>
  <head>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
    <script src="https://d3js.org/d3-hierarchy.v2.min.js"></script>
    <style> /* set the CSS */

      div.tooltip {
        position: absolute;
        text-align: left;
        width: auto;
        height: auto;
        padding: 5px;
        font: 12px sans-serif;
        /* background: lightsteelblue; */
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
      }

      .article-backgraound {
        background-color: beige;
      }

      .article-width {
        width: 300px;
        border-radius: 5%;
      }
      .title {
        font-size: 20px;
        color: black;
        margin-left: 10px;
      }

      div#articles {
        border-radius: 5%;
      }

      div.top {
        height: 45px;
        border-radius: 30% 30% 0% 0%;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      div.bottom {
        height: 45px;
        border-top: 2px solid white;
        border-radius: 0% 0% 0% 0%;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #switch {
        width: 15px;
        height: 15px;
        cursor: pointer;
      }

      .arrow {
        width: 20px;
        height: 20px;
        margin: 0px 15px 0px 15px;
      }

      div.switch-button {
        margin-right: 10px;
      }

      div.article-text {
        font-size: 10px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        margin-right: 10px;
        margin-top: 3px;
        margin-bottom: 3px;
      }

      a.section {
        height: 60px;
        border-top: 2px solid white;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        margin: 2px 10px 2px 10px;
        text-decoration: none;
        color: black;
      }

      #page-number {
        font-size: 12px;
      }

      #right {
        margin-top: 20px;
        display: flex;
        flex-direction: row;
        justify-content: space-evenly;
      }

      #calendar-bunch {
        margin-top: 10px;
      }

    </style>
  </head>
  <body>
    <h1>Smart Street Bets</h1>
    <h2>Bitcoin (BTC)</h2>
    <div id="all">
      <div id="left">
        <!-- Chart  -->
        <div id="chart">
        </div>
        <div id="calculation">
        </div>
      </div>

      <div id="right">
        <!-- calendar -->
        <div id="calendar-section">
          <label for="calendar"> Please select date and time: </label>
          <div id="calendar-bunch">
            <input type="datetime-local" id="calendar" name="calendar">
            <input type="submit" onclick="submitDateTime()">
          </div>
          <p id="current-date"></p>
        </div>

        <div class="articles article-backgraound article-width">
          <div class="top">
            <h2 class="title" id="title">Articles</h2>
            <div class="switch-button">
              <img id="switch" src="switch.png" onclick="toggleMode()">
            </div>
          </div>
          <a class="section" id="article-0">
            <div class="article-text" id="article-0-text"> 
            </div>
            <div class="article-img" id="article-0-img"> 
            </div>
          </a>
          <a class="section" id="article-1">
            <div class="article-text" id="article-1-text"> 
            </div>
            <div class="article-img" id="article-1-img"> 
            </div>
          </a>
          <a class="section" id="article-2">
            <div class="article-text" id="article-2-text"> 
            </div>
            <div class="article-img" id="article-2-img"> 
            </div>
          </a>
          <a class="section" id="article-3">
            <div class="article-text" id="article-3-text"> 
            </div>
            <div class="article-img" id="article-3-img"> 
            </div>
          </a>
          <div class="bottom">
            <img class="arrow" id="left-arrow" src="left_arrow.png" onclick="prevPage()">
            <p id="page-number"></p>
            <img class="arrow" id="right-arrow" src="right_arrow.png" onclick="nextPage()">
          </div>
        </div>

      </div>

    </div>
    <script type="text/javascript" src="articles.json"></script>
    <script type="text/javascript" src="posts.json"></script>
    <script>

        const height = 300;
        const width = 1200; // Not sure if this is needed
        const margin = ({top: 20, right: 30, bottom: 30, left: 40})

        // Functions
        let parseDate = d3.utcParse("%Y-%m-%d");
        let formatChange = (y0, y1) => {
            const f = d3.format("+.2%");
            return (y0, y1) => f((y1 - y0) / y0);
          }

        let formatValue = d3.format(".2f");
        let formatDate = d3.utcFormat("%B %-d, %Y");

        let tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

        d3.csv("https://raw.githubusercontent.com/6859-sp21/final-project-smart-street-bets/main/BTC-USD.csv")
        .then(data => {
          // Last 120 days of dataset 
          const data120 = data.map(d => {
            const date = parseDate(d["Date"]);
            return {
              date,
              high: +d["High"],
              low: +d["Low"],
              open: +d["Open"],
              close: +d["Close"]
            };
          }).slice(-120);

          let xAxis = (g) => {
            g.attr("transform", `translate(0,${height - margin.bottom})`)
              .call(d3.axisBottom(x)
                .tickValues(d3.utcMonday
                    .every(width > 720 ? 1 : 2)
                    .range(data120[0].date, data120[data120.length - 1].date))
                .tickFormat(d3.utcFormat("%-m/%-d")))
              .call(g => g.select(".domain").remove())
          }

          let yAxis = (g) => {
            g.attr("transform", `translate(${margin.left},0)`)
              .call(d3.axisLeft(y)
                .tickFormat(d3.format("$~f"))
                .tickValues(d3.scaleLinear().domain(y.domain()).ticks()))
              .call(g => g.selectAll(".tick line").clone()
                .attr("stroke-opacity", 0.2)
                .attr("x2", width - margin.left - margin.right))
              .call(g => g.select(".domain").remove())
          }

          let x = d3.scaleBand()
            .domain(d3.utcDay
                .range(data120[0].date, +data120[data120.length - 1].date + 1)
                // Crypto is 24/7
                // .filter(d => d.getUTCDay() !== 0 && d.getUTCDay() !== 6)
                )
            .range([margin.left, width - margin.right])
            .padding(0.2);

          let y = d3.scaleLog()
            .domain([d3.min(data120, d => d.low), d3.max(data120, d => d.high)])
            .rangeRound([height - margin.bottom, margin.top])
            const svg = d3.create("svg")
            .attr("viewBox", [0, 0, width, height]);

          svg.append("g")
              .call(xAxis);

          svg.append("g")
              .call(yAxis);

          const g = svg.append("g")
            .attr("stroke-linecap", "round")
            .attr("stroke", "black")
            .selectAll("g")
            .data(data120)
            .join("g")
              // Have to parse the date
              // Problem with x
              .attr("transform", d => `translate(${x(d.date)},0)`);
            

          // Getting undefined
          g.append("line")
            .attr("y1", d => y(d.low))
            .attr("y2", d => y(d.high));

          g.append("line")
            .attr("y1", d => y(d.open))
            .attr("y2", d => y(d.close))
            .attr("stroke-width", x.bandwidth())
            .attr("stroke", d => d.open > d.close ? d3.schemeSet1[0]
              : d.close > d.open ? d3.schemeSet1[2]
              : d3.schemeSet1[8])
            .on("mouseover", function(event, d) {
              tooltip.transition()
                .duration(200)
                .style("opacity", .9);
              tooltip.html("Date: " + d.date.toString().slice(0,15) + "<br/> Open: " + d.open + "<br/> Close: " + d.close + "<br/> Low: " + 
                            d.low + "<br/> High: " + d.high)
                .style("left", (event.pageX) + "px")
                .style("background", "beige")
                .style("top", (event.pageY - 28) + "px");

              d3.select(this)
                .attr("opacity", .5)
            })
            .on("mouseout", function(event, d) {
              tooltip.transition()
                .duration(500)
                .style("opacity", 0);

              d3.select(this)
                .attr("opacity", 1)
            })

          g.append("title")
              .text(d => `${formatDate(d.date)}
              Open: ${formatValue(d.open)}
              Close: ${formatValue(d.close)} (${formatChange(d.open, d.close)})
              Low: ${formatValue(d.low)}
              High: ${formatValue(d.high)}`);
          
              document.getElementById("chart").appendChild(svg.node());
        })
            
      const imgSize = {width: 50, height: 50};

      const monthList = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.', 'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.'];

      function pad(num, size) {
        num = num.toString();
        while (num.length < size) {
          num = "0" + num;
        }
        return num;
      }

      function formatDateString(dateString) {
        let date = new Date(dateString);

        let year = date.getFullYear();
        let month = monthList[date.getMonth()];
        let dateNo = date.getDate();
        let hour = date.getHours();
        let minute = date.getMinutes();

        return hour + ':' + pad(minute, 2) + ' ' + dateNo + ' ' + month + ' ' + year
      }

      function reloadArticles(articles) {
        let length = Math.min(4, articles.length);
        for (let i = 0; i < length; i++) {
          let id = "#article-" + i;
          let section = document.querySelector(id);
          section.href = articles[i].href;

          let textId = "#article-" + i + "-text";
          let imgId = "#article-" + i + "-img";
          let sectionText = document.querySelector(textId);

          let titleTag = document.createElement("p");
          let title = document.createTextNode(articles[i].title);
          titleTag.appendChild(title);

          let infoTag = document.createElement("p");
          let info = document.createTextNode(articles[i].source + ' | ' + formatDateString(articles[i].date));
          infoTag.appendChild(info);

          sectionText.appendChild(titleTag);
          sectionText.appendChild(infoTag);

          if ('img' in articles[i]) {
            let sectionImage = document.querySelector(imgId);

            let imgTag = document.createElement("img");
            imgTag.src = articles[i].img;
            imgTag.height = imgSize.height;
            imgTag.width = imgSize.width;

            sectionImage.appendChild(imgTag);
          }

          if ((page+1)*4 >= articlesSmall.length) {
            blockButton("right");
          } else {
            unblockButton("right");
          }

          if (page === 0) {
            blockButton("left");
          } else {
            unblockButton("left");
          }

          let pageNum = document.querySelector("#page-number");
          pageNum.innerHTML = (page+1) + "/" + Math.ceil(articlesSmall.length / 4);
        }
      }

      function reloadReddit(posts) {
        let length = Math.min(4, posts.length);
        for (let i = 0; i < length; i++) {
          let id = "#article-" + i;
          let section = document.querySelector(id);
          section.href = posts[i].href;

          let textId = "#article-" + i + "-text";
          
          let sectionText = document.querySelector(textId);

          let titleTag = document.createElement("p");
          let title = document.createTextNode(truncateTitle(posts[i].title));
          titleTag.appendChild(title);

          let infoTag = document.createElement("p");
          let info;
          if ('subreddit' in posts[i]) {
            info = document.createTextNode(posts[i].subreddit + ' | ' + formatDateString(posts[i].date));
          } else {
            info = document.createTextNode(formatDateString(posts[i].date));
          }
          infoTag.appendChild(info);

          sectionText.appendChild(titleTag);
          sectionText.appendChild(infoTag);
        }

        if ((page+1)*4 >= redditSmall.length) {
          blockButton("right");
        } else {
          unblockButton("right");
        }

        if (page === 0) {
          blockButton("left");
        } else {
          unblockButton("left");
        }

        let pageNum = document.querySelector("#page-number");
        pageNum.innerHTML = (page+1) + "/" + Math.ceil(redditSmall.length / 4);
      }

      function truncateTitle(title) {
        if (title.length > 90) {
          return title.slice(0, 90) + '...'; 
        }
        return title
      }

      function deleteArticles() {
        for (let i = 0; i < 4; i++) {
          let textId = "#article-" + i + "-text";
          let imgId = "#article-" + i + "-img";

          let sectionText = document.querySelector(textId);
          let sectionImage = document.querySelector(imgId);

          sectionText.querySelectorAll('*').forEach(n => n.remove());
          sectionImage.querySelectorAll('*').forEach(n => n.remove());
        }

        let pageNum = document.querySelector("#page-number");
        pageNum.innerHTML = "";
      }

      let mode = 0 // 0: articles 1: posts
      var articlesSmall = []; // This will be displayed.
      var redditSmall = []; // This will be displayed.
      let page = 0;
      let globalTime = undefined;
      setInterval(incrementTime, 60000)

      function toggleMode() {
        page = 0;
        deleteArticles();
        let title = document.querySelector('#title');

        if (mode === 0) {
          mode = 1;
          title.innerHTML = "Reddit"
          reloadReddit(redditSmall);
        } else {
          mode = 0;
          title.innerHTML = "Articles"
          reloadArticles(articlesSmall);
        }
      }

      function nextPage() {
        deleteArticles();
        page++;
        if (mode === 0) {
          reloadArticles(articlesSmall.slice(4*page, 4*(page+1)));
        } else {
          reloadReddit(redditSmall.slice(4*page, 4*(page+1)));
        }
      }

      function prevPage() {
        deleteArticles();
        page--;
        if (mode === 0) {
          reloadArticles(articlesSmall.slice(4*page, 4*(page+1)));
        } else {
          reloadReddit(redditSmall.slice(4*page, 4*(page+1)));
        }
      }

      function blockButton(flag) {

        if (flag === "right") {
          let right = document.querySelector("#right-arrow");
          right.onclick = null;
          right.style.opacity = 0.4;
        }

        if (flag === "left") {
          let left = document.querySelector("#left-arrow");
          left.onclick = null;
          left.style.opacity = 0.4;
        }
      }

      function unblockButton(flag) {
        if (flag === "right") {
          let right = document.querySelector("#right-arrow");
          right.onclick = nextPage;
          right.style.opacity = 1;
        }

        if (flag === "left") {
          let left = document.querySelector("#left-arrow");
          left.onclick = prevPage;
          left.style.opacity = 1;
        }
      }

      function submitDateTime() {
        deleteArticles();
        filterArticles();
        globalTime = new Date(document.querySelector("#calendar").value);
        displayDateTime();
      }

      function incrementTime() {
        if (globalTime !== undefined) {
          globalTime = new Date(globalTime.getTime() + 60000);
          displayDateTime();
        }
      }

      function displayDateTime() {
        let text = document.querySelector("#current-date");
        text.innerHTML = formatDateString(globalTime);
      }

      function getDateString(date) {
        let year = date.getFullYear();
        let mm = pad(date.getMonth()+1, 2);
        let dd = pad(date.getDate(), 2);
        return year + '-' + mm + '-' + dd;
      }

      function filterArticles() {
        let dateString = document.querySelector("#calendar").value;
        let today = new Date(dateString);
        let todayString = dateString.slice(0,10);

        let yesterday = new Date(today.getTime())
        yesterday.setDate(today.getDate() - 1);
       
        let yesterdayString = getDateString(yesterday);
        
        articles1 = articles[yesterdayString];
        articles2 = articles[todayString].filter(d => d.date < today);
        articlesSmall = articles1.concat(articles2);
        
        reddit1 = posts[yesterdayString];
        reddit2 = posts[todayString].filter(d => d.date < today);
        redditSmall = reddit1.concat(reddit2);
        
        page =0;

        if (mode === 0) {
          reloadArticles(articlesSmall);
        } else {
          reloadReddit(redditSmall);
        }
      }

      // 1. Download data
      d3.csv("https://raw.githubusercontent.com/6859-sp21/a4-videogamessales/main/vgsalesglobale.csv")
      .then(data => {
      // 2. Setting up variables that describe our chart's space.
      const height = 450;
      const width = 800;
      const margin = ({top: 20, right: 60, bottom: 35, left: 60});
      
      const colorScale = d3.scaleOrdinal()
          .domain([0,9])
          .range(d3.schemeTableau10);

      const colorScale12 = d3.scaleOrdinal()
          .domain([0,11])
          .range(d3.schemeSet3);

      })
      
    </script>
  </body>

  <!-- This adapted from Arvind's observable from lecture. https://observablehq.com/d/4c93c3a516d35624 -->
  <!-- Great D3 intro resource: https://observablehq.com/@d3/learn-d3?collection=@d3/learn-d3 -->
</html>